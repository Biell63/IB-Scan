<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>IB Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
<div class="app">

  <aside class="sidebar">
    <h1>IB Scan</h1>
    <nav class="nav">
      <button id="menuAudit" class="menu active">Auditoria</button>
      <button id="menuHistory" class="menu">Histórico</button>
    </nav>
    <div class="sidebar-footer">
      <small>IB Scan © 2026</small>
    </div>
  </aside>

  <main class="content">

    <!-- LOGIN -->
    <section id="view-login" class="card intro hidden">
      <header class="card-header center">
        <h2>Acesso ao IB Scan</h2>
        <p>Auditoria técnica e proteção de arquivos sensíveis em ambiente offline.</p>
      </header>

      <div class="form">
        <div class="field">
          <label>Login</label>
          <input id="loginUser" type="text">
        </div>

        <div class="field">
          <label>Senha</label>
          <input id="loginPass" type="password">
        </div>

        <button id="loginBtn" class="primary full">Entrar</button>
        <div id="loginError" class="placeholder"></div>
      </div>
    </section>
    <section id="view-audit" class="hidden">

      <section class="card intro">
        <header class="card-header">
          <div>
            <h2>Auditoria LGPD Offline</h2>
            <p class="muted">
              Identificação técnica de arquivos potencialmente sensíveis.
            </p>
          </div>
          <button id="startScan" class="primary">Iniciar Varredura</button>
        </header>
      </section>

      <section class="card">
        <header class="card-header">
          <h3>Resultado da Análise</h3>
        </header>

        <div id="progress" class="progress hidden">
          <div class="bar"></div>
          <span id="progressText"></span>
        </div>

        <div id="output" class="placeholder">
          Nenhuma varredura realizada.
        </div>
      </section>
    </section>
    <section id="view-history" class="hidden">
      <section class="card intro">
        <header class="card-header">
          <h2>Histórico de Auditorias</h2>
          <p class="muted">Registros técnicos anteriores</p>
        </header>
      </section>

      <section class="card">
        <div id="historyList" class="placeholder">
          Nenhuma auditoria registrada ainda.
        </div>
      </section>
    </section>
  </main>
</div>
<script>
(() => {
  const $ = id => document.getElementById(id);
  const safeDecode = s => { try { return decodeURIComponent(s); } catch { return s; } };
  const viewLogin = $('view-login');
  const viewAudit = $('view-audit');
  const viewHistory = $('view-history');
  const menuAudit = $('menuAudit');
  const menuHistory = $('menuHistory');
  const loginBtn = $('loginBtn');
  const loginUser = $('loginUser');
  const loginPass = $('loginPass');
  const loginError = $('loginError');
  const startBtn = $('startScan');
  const output = $('output');
  const progressBox = $('progress');
  const progressBar = progressBox.querySelector('.bar');
  const progressText = $('progressText');
  let busy = false;
  let lastFindings = [];
  function hideAll() {
    viewLogin.classList.add('hidden');
    viewAudit.classList.add('hidden');
    viewHistory.classList.add('hidden');
  }
  function showAudit() {
    hideAll();
    viewAudit.classList.remove('hidden');
    menuAudit.classList.add('active');
    menuHistory.classList.remove('active');
  }

  function showHistory() {
    hideAll();
    viewHistory.classList.remove('hidden');
    menuHistory.classList.add('active');
    menuAudit.classList.remove('active');
    loadHistory();
  }

  menuAudit.onclick = showAudit;
  menuHistory.onclick = showHistory;

  loginBtn.onclick = async () => {
    loginError.textContent = '';
    const r = await window.IBScan.login(
      loginUser.value.trim(),
      loginPass.value
    );
    if (!r.ok) {
      loginError.textContent = r.error;
      return;
    }
    showAudit();
  };

  window.IBScan.onProgress(p => {
    if (!p.total) return;
    const percent = Math.floor((p.processed / p.total) * 100);
    progressBox.classList.remove('hidden');
    progressBar.style.width = percent + '%';
    progressText.textContent = `Analisando ${p.processed} de ${p.total}`;
  });

  startBtn.onclick = async () => {
    if (busy) return;
    busy = true;
    startBtn.disabled = true;

    output.textContent = 'Selecione a pasta para auditoria...';

    const folder = await window.IBScan.selectFolder();
    if (!folder) {
      output.textContent = 'Operação cancelada.';
      busy = false;
      startBtn.disabled = false;
      return;
    }

    const result = await window.IBScan.runScan(folder);
    if (!result.ok) {
      output.textContent = result.error;
      busy = false;
      startBtn.disabled = false;
      return;
    }

    const { summary, findings } = result.data;
    lastFindings = findings || [];

    let html = `
      <div class="summary">
        <div><b>Analisados:</b> ${summary.analyzed}</div>
        <div><b>Com risco:</b> ${summary.compromised}</div>
        <div class="risks">
          <span class="risk ALTO">ALTO ${summary.byRisk.ALTO}</span>
          <span class="risk MEDIO">MÉDIO ${summary.byRisk.MEDIO}</span>
          <span class="risk BAIXO">BAIXO ${summary.byRisk.BAIXO}</span>
        </div>
      </div>
    `;

    if (!lastFindings.length) {
      html += `<p class="clean">Nenhum dado sensível identificado.</p>`;
    } else {
      html += `<div class="findings">`;

      lastFindings.forEach(f => {
        html += `
          <article class="finding ${f.risk}">
            <header class="finding-header">
              <strong>${safeDecode(f.file.split(/[\\/]/).pop())}</strong>
              <span class="risk ${f.risk}">${f.risk}</span>
            </header>

            <section class="description">
              <b>Motivo do risco</b>
              <ul>${f.findings.map(x => `<li>${x.description}</li>`).join('')}</ul>
            </section>

            <footer class="finding-footer">
              <code class="path">${safeDecode(f.file)}</code>
              <button class="openFile" data-path="${f.file}">Abrir arquivo</button>
            </footer>
          </article>
        `;
      });

      html += `
        </div>

        <div class="actions">
          <button id="protectBtn" class="primary danger">
            Proteger arquivos identificados
          </button>

          <button id="exportPdf" class="primary">
            Exportar relatório PDF
          </button>
        </div>

        <p class="muted" style="margin-top:10px;font-size:12px;">
          A proteção aplica permissões do sistema operacional.
          Nenhum arquivo é criptografado ou alterado internamente.
        </p>
      `;
    }

    output.innerHTML = html;

    document.querySelectorAll('.openFile').forEach(b =>
      b.onclick = () => window.IBScan.openFile(b.dataset.path)
    );

    const exportBtn = $('exportPdf');
    if (exportBtn) {
      exportBtn.onclick = async () => {
        exportBtn.disabled = true;
        exportBtn.textContent = 'Gerando PDF...';
        const r = await window.IBScan.exportReport();
        exportBtn.textContent = r.ok ? 'PDF gerado' : 'Erro ao gerar PDF';
      };
    }

    const protectBtn = $('protectBtn');
    if (protectBtn) {
      protectBtn.onclick = async () => {
        if (!confirm(
          'Os arquivos serão movidos para uma pasta protegida ' +
          'com permissões do sistema operacional. Deseja continuar?'
        )) return;

        const files = lastFindings.map(f => f.file);
        const targetFolder = await window.IBScan.selectFolder();
        if (!targetFolder) return;

        protectBtn.disabled = true;
        protectBtn.textContent = 'Aplicando proteção...';

        const res = await window.IBScan.protectionApply({
          files,
          targetFolder
        });

        protectBtn.textContent = res.ok
          ? 'Arquivos protegidos'
          : 'Falha na proteção';
      };
    }

    busy = false;
    startBtn.disabled = false;
  };

  async function loadHistory() {
    const box = $('historyList');
    box.textContent = 'Carregando histórico...';

    const list = await window.IBScan.getHistory();
    if (!list.length) {
      box.textContent = 'Nenhuma auditoria registrada ainda.';
      return;
    }

    box.innerHTML = `
      <div class="history-actions">
        <button id="clearHistory" class="history-clear">
          Limpar histórico
        </button>
      </div>

      <div class="history">
  ${list.map(h => `
    <div class="history-item">
      <div class="history-header">

        <div class="history-info">
          <span class="history-title">${new Date(h.date).toLocaleString()}</span>
          <span class="history-meta">${h.folder}</span>

          <div class="history-risks">  
            <span class="ALTO">ALTO ${h.summary?.byRisk?.ALTO ?? 0}</span>
            <span class="MEDIO">MÉDIO ${h.summary?.byRisk?.MEDIO ?? 0}</span>
            <span class="BAIXO">BAIXO ${h.summary?.byRisk?.BAIXO ?? 0}</span>
          </div>
        </div> <!-- ✅ FECHOU history-info -->

        <button class="toggle">Detalhes</button>

      </div>

      <div class="history-details hidden">
        <p><b>Analisados:</b> ${h.summary?.analyzed ?? 0}</p>
        <p><b>Com risco:</b> ${h.summary?.compromised ?? 0}</p>
        <button class="primary exportPdf" data-id="${h.id}">
          Baixar PDF
        </button>
      </div>
    </div>
  `).join('')}
</div>

    `;

    box.querySelectorAll('.toggle').forEach(b =>
      b.onclick = () =>
        b.closest('.history-item')
          .querySelector('.history-details')
          .classList.toggle('hidden')
    );

    box.querySelectorAll('.exportPdf').forEach(b =>
      b.onclick = async () => {
        b.disabled = true;
        b.textContent = 'Gerando...';
        const r = await window.IBScan.exportHistoryPdf(b.dataset.id);
        b.textContent = r.ok ? 'PDF gerado' : 'Erro';
      }
    );

    $('clearHistory').onclick = async () => {
      if (!confirm('Deseja remover todo o histórico?')) return;
      await window.IBScan.clearHistory();
      loadHistory();
    };
  }

})();
</script>

</body>
</html>
